# 成员D - STEP2和STEP4接口，以及遇到的问题和解决方法

> **负责人**: 成员D  
> **完成日期**: 2026-01-17  
> **状态**: ✅ 全部完成并测试通过

---

## 📁 文件位置总览

```
llm25/
└── src/
    └── tools/
        ├── __init__.py
        ├── phonology_tool.py       # 音韵查询工具
        └── pattern_tool.py         # 训式识别工具
    
```

---

## 🎯 STEP2接口: 音韵查询工具

### 任务内容
提供上古音韵数据的查询和比较功能，支持判断两字是否"音近"。

### 数据来源
- 潘悟云《汉语古音手册》: 13,445 字
- 白一平-沙加尔上古音: 4,056 字
- 整合后共: **13,666** 个字

### 使用方式

```python
from src.tools.phonology_tool import query_phonology, check_phonetic_relation

# 1. 查询单个字的音韵信息
char_info = query_phonology("崇")
# 返回结果示例:
# {
#     "字": "崇",
#     "声母": "崇",                   # 潘悟云体系声母
#     "韵部": "東",                   # 潘悟云体系韵部
#     "上古音": "*[dz]<r>uŋ",         # 智能展示：优先BS拟音，无则展示潘拟音
#     "上古音来源": "白一平-沙加尔汉语拟音"  # 标明数据来源
# }

# 2. 比较两字的音韵关系
result = check_phonetic_relation("崇", "终")
# 返回结果示例:
# {
#     "is_close": True,          # 【核心结论】 True=音近(可假借/声训), False=音远
#     "same_yunbu": True,        # 是否叠韵 (金标准)
#     "same_shengmu": False,     # 是否双声 (辅助信息)
#     "analysis": "✅ 【叠韵】(均为東部)；拟音: 崇[*[dz]<r>uŋ] vs 终[*tuŋ]", # 给LLM看的分析文案
#
#     "char1_info": {            # 第一个字的详情 ("崇")
#         "繁体": "崇",
#         "声母": "崇",
#         "韵部": "東",
#         "上古音": "*[dz]<r>uŋ",
#         "上古音来源": "白一平-沙加尔汉语拟音"
#     },
#
#     "char2_info": {            # 第二个字的详情 ("终")
#         "繁体": "終",
#         "声母": "章",          # 注意：声母不同 (崇 vs 章)
#         "韵部": "東",          # 注意：韵部相同 (均为 東) -> 判定为音近
#         "上古音": "*tuŋ",
#         "上古音来源": "白一平-沙加尔汉语拟音"
#     }
# }
```

### ⚠️ 注意事项
1. **繁简无忧**: 接口内部集成了 OpenCC，输入为简体或繁体皆可，接口会自动转为繁体去查索引（例如输入 "终" (简)，内部会自动转为 "終" (繁) 去查索引）。
2. **缺失数据**: 若字不在数据库中，查询函数返回的字段会显示"未收录"，比较函数返回的"is_close"字段会显示为False
3. **音近判断**: 韵部相同时直接判断为"音近"，拟音相似(Sim>0.75)也会判断为"音近"，若只有声母相同则不会判断为"音近"

---

## 🎯 STEP4接口: 训式识别工具

### 任务内容
识别训诂格式，判断使用了什么训诂术语

### 数据源
训式规则表（正则表达式），基于郑玄注、《说文》及《声训法》参考资料

### 使用方式

```python
from src.tools.pattern_tool import identify_pattern

# 输入一个训诂句子
result = identify_pattern("崇，读为终")
# 返回结果示例:
# {
#     "格式": "读为",
#     "被释字": "崇",
#     "释字": "终",
#     "暗示类型": "假借",         # 核心结论：这是一个假借关系（通假字）
#     "置信度": "极高",           # 证据等级：这是郑玄注里的标准术语，可信度极高
#     "可直接判定": True,         # 流程控制：因为是铁证，Agent可以直接采纳，无需强制跑音韵验证
#     "说明": "郑玄《礼》注，破字/改读术语"
# }
```

### ⚠️ 注意事项
1. **简繁无忧**: 接口内部集成了 OpenCC，输入为简体或繁体皆可，接口会自动转为简体去识别训诂格式。
2. **训式识别**: 按照 强假借 > 强语义/声训 > 弱假借 > 兜底规则 的优先级进行识别。

---

## 遇到的问题及解决方法
### 问题描述
 在构建古籍训诂类型判定系统时，如何准确判定两个汉字是否“音近”是区分“声训”与“义训”的关键前置条件。在传统训诂学（如王力体系）中，判断音近的核心依据是韵部，实际上，古书中大量存在韵部名称不同、但发音极近的“合韵”现象（如“阴阳对转”、“旁转”）。若仅靠韵部名称进行机械匹配，会导致大量真实的声训关系被误判为“音远”，从而遗漏关键证据。

### 解决方法
本项目的“音韵查询工具”采用了一种混合判定算法，将传统训诂学中的“韵部理论”与现代计算语言学的“编辑距离算法”相结合。该算法旨在模拟古人进行“声训”时的语音联想逻辑，确保判定结果既符合传统学术规范，又具备处理模糊语音关联的灵活性。

以下为本算法的三大核心判定依据及其理论来源：

#### 1. 核心准则：以“叠韵”为最高判定标准
**算法逻辑：** 当两个汉字属于同一韵部时，系统直接判定二者为“音近”。这是算法中的“金标准”，具有最高优先级。

**理论依据：** 在传统声训与同源词研究中，韵母的权重远高于声母。

刘熙《释名》：作为汉代声训的集大成之作，书中绝大多数声训条例均基于“叠韵”或“韵近”关系。

王力《同源字典》：王力先生明确指出：“同源字在声音上的关系……以叠韵为多，以双声为少。”这奠定了“韵部相同即音近”的理论基石（参见参考资料2《声训法》）。

#### 2. 辅助准则：基于拟音相似度的“通转”判定
**算法逻辑：** 针对韵部名称不同、但发音极度相似的情况，本算法引入 白一平-沙加尔汉语拟音 以及 潘悟云《汉语古音手册》 中的上古拟音数据，计算两个汉字 IPA（国际音标）的归一化编辑距离（Normalized Levenshtein Distance）。若相似度阈值高于 0.75，即使韵部不同，也判定为“音近”。

**理论依据：** 上古音韵部并非孤立，相邻韵部之间存在显著的“通转”现象。

阴阳对转与旁转：根据章太炎《成均图》及王力音韵学理论，阴声韵（如元部 *-an）与入声韵（如月部 *-at）虽然韵部归属不同，但主要元音相同、韵尾发音部位一致，听感极近。

计算语言学应用：引入拟音相似度计算，能够有效捕捉这种“名异实同”的语音关系，弥补了单纯依赖韵部名称分类过于机械的缺陷，符合“合韵”的语言事实。

#### 3. 单纯“双声”不作为独立判定依据
**算法逻辑：** 若两个汉字仅声母相同（双声），但韵部差异巨大且拟音相似度低于阈值，系统不判定为音近。声母相同在报告中仅作为辅助描述信息呈现。

**理论依据：** 声训的核心目的在于“通义”，单纯的声母相同而韵母迥异，通常无法构成有效的语义解释关联。

齐佩蓉《训诂学概论》：在音训理论中，强调声音关系必须足以建立意义联系。例如“大”（dà，铎部）与“多”（duō，歌部）虽同属端母（双声），但因韵部差异过大，古人并不将其视为可互训的音近字。因此，排除单纯双声可以有效降低算法的误判率（False Positive）。

### 参考文献：
王力. (1980). 《汉语史稿》. 中华书局.
王力. (1982). 《同源字典》. 商务印书馆.
Baxter, W. H., & Sagart, L. (2014). Old Chinese: A New Reconstruction. Oxford University Press.
齐佩蓉. (1984). 《训诂学概论》. 中华书局.