# 训诂句类型智能判断系统

> 大语言模型课程实践项目 - 数字人文方向
> 
> 基于LLM Agent的古汉语训诂分类系统

---

## 📋 目录

- [项目概述](#项目概述)
- [核心任务](#核心任务)
- [学术背景](#学术背景)
- [系统架构](#系统架构)
- [技术选型](#技术选型)
- [数据资源](#数据资源)
- [五步推理流程](#五步推理流程)
- [实现计划](#实现计划)
- [团队分工](#团队分工)
- [开发里程碑](#开发里程碑)
- [项目结构](#项目结构)
- [使用说明](#使用说明)
- [评估与测试](#评估与测试)
- [参考文献](#参考文献)

---

## 项目概述

### 背景

训诂学是中国传统语言学的核心组成部分，主要研究古代文献中的词义解释。在古代训诂实践中，存在两种重要的训释类型：

1. **以声通义法**（语义解释）：利用声音相近的词来解释词义，揭示词的语源
2. **揭明正借字法**（假借说明）：指出文献中某字是另一字的假借

这两种类型在形式上常常相似（都涉及音近字），但本质不同：
- 语义解释：**音近义近**，A与B有语义关联
- 假借说明：**音近义远**，A只是借用了B的音，本身无义

### 项目目标

构建一个基于大语言模型的智能Agent系统，能够：

1. **自动分类**：判断输入的训诂句属于"语义解释"还是"假借说明"
2. **提供推理链**：输出完整的五步推理过程和证据
3. **工具调用**：自主调用字典查询、音韵查询等外部工具获取信息


## 核心任务

### 输入

一条训诂句，例如：
```
崇，终也。——《毛传》
```

### 输出

1. **分类结果**：`假借说明` 或 `语义解释`（以声通义）
2. **推理过程**：完整的五步分析
3. **证据链**：支持判断的具体依据

### 输出示例

```json
{
  "input": {
    "训诂句": "崇，终也",
    "被释字": "崇",
    "释字": "终",
    "出处": "《诗·邶风·简兮》《毛传》"
  },
  "classification": "假借说明",
  "confidence": 0.95,
  "reasoning": {
    "step1_semantic": {
      "conclusion": "义远",
      "evidence": {
        "崇_本义": "《说文》：崇，嵬高也。核心义：高大、尊崇",
        "终_本义": "《说文》：终，絿丝也。核心义：终结、完整",
        "关联性": "高大与终结无语义关联链条"
      }
    },
    "step2_phonetic": {
      "conclusion": "音近",
      "evidence": {
        "崇_上古音": "禅母·东部 (ʑiwoŋ)",
        "终_上古音": "章母·东部 (tɕiwoŋ)",
        "分析": "韵部相同（东部），声母同属舌音，符合音近假借条件"
      }
    },
    "step3_textual": {
      "conclusion": "有异文佐证",
      "evidence": {
        "异文": "《小雅·采绿》作'终朝'，与'崇朝'形成异文",
        "分析": "同一词义用不同字形，直接证明正借关系"
      }
    },
    "step4_terminology": {
      "conclusion": "训式不确定",
      "evidence": {
        "训式": "A，B也",
        "分析": "《毛传》时代术语不严格，需结合其他证据"
      }
    },
    "step5_context": {
      "conclusion": "支持假借",
      "evidence": {
        "原句": "崇朝其雨",
        "崇_本义代入": "'高大早晨下雨'，语义不通",
        "终_本义代入": "'整个早晨下雨'，语义通顺",
        "判断": "借字本义不通，正字本义通顺，坐实假借"
      }
    }
  },
  "final_judgment": "综合五步分析：义远、音近、有异文、训式不定、语境支持假借 → 判定为【假借说明】"
}
```

---

## 学术背景

### 训诂学基础

训诂学是研究古代文献词义的学问，核心方法包括：

| 方法 | 说明 | 代表著作 |
|------|------|----------|
| 义训法 | 直接解释词义 | 《尔雅》《说文》 |
| 声训法 | 利用声音关系训释 | 《释名》《白虎通义》 |
| 形训法 | 根据字形解释 | 《说文解字》 |

### 声训法的两大分支

```
声训法
├── 以声通义法（语义解释）
│   ├── 特点：音近义近
│   ├── 目的：揭示语源，沟通音义
│   └── 例：海，晦也（海因其色黑而晦得名）
│
└── 揭明正借字法（假借说明）
    ├── 特点：音近义远
    ├── 目的：指出借字与正字的对应关系
    └── 例：崇，终也（崇是终的借字）
```

### 区分的重要性

误判会导致对古文的错误理解：
- 把假借当语义解释 → 望文生义，曲解原意
- 把语义解释当假借 → 割裂词源，丢失文化信息

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户输入层                               │
│                  (训诂句 + 上下文信息)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Agent 核心层                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    LLM (Claude/GPT-4)                    │   │
│  │                                                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ 任务规划 │  │ 推理执行 │  │ 结果整合 │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                │                                 │
│                         工具调用接口                             │
│                                │                                 │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐      │
│  │ 字义查询 │ 音韵查询 │ 文献检索 │ 训式识别 │ 语境分析 │      │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        知识库层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │《汉语大词典》 │  │  上古音数据  │  │《王力古汉语》│          │
│  │   (JSONL)    │  │   (TXT)      │  │   (MDX)     │          │
│  │   1.9GB      │  │   多来源     │  │   5.5MB     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  训式规则库  │  │  测试数据集  │  │  参考资料库  │          │
│  │   (JSON)     │  │   (JSON)     │  │   (TXT)     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         输出层                                   │
│              (分类结果 + 推理过程 + 证据链)                      │
└─────────────────────────────────────────────────────────────────┘
```

### 核心组件

| 组件 | 功能 | 技术实现 |
|------|------|----------|
| **LLM核心** | 任务规划、推理、决策 | Claude API / OpenAI API |
| **工具函数** | 提供外部知识查询能力 | Python Functions |
| **知识库** | 存储字典、音韵等数据 | JSONL + 向量数据库 |
| **训式识别器** | 正则匹配训诂格式 | Python Regex |
| **语境分析器** | 判断语义通顺度 | LLM Prompt |

---

## 技术选型

### 核心技术栈

| 类别 | 选型 | 理由 |
|------|------|------|
| **编程语言** | Python 3.10+ | 生态丰富，AI库支持好 |
| **LLM** | Claude 3.5 Sonnet / GPT-4 | 推理能力强，中文理解好 |
| **Agent框架** | LangChain / 自研 | 工具调用、记忆管理 |
| **向量数据库** | ChromaDB / FAISS | 轻量、本地部署 |
| **数据处理** | Pandas, JSON | 结构化数据处理 |

### 技术架构选择

```
方案A：LangChain Agent（推荐新手）
├── 优点：开箱即用，社区活跃
├── 缺点：抽象层多，定制性稍弱
└── 适用：快速原型，通用场景

方案B：自研Agent框架
├── 优点：完全可控，深度定制
├── 缺点：开发量大
└── 适用：特定需求，深度优化

方案C：LlamaIndex
├── 优点：RAG能力强
├── 缺点：Agent功能相对弱
└── 适用：以检索为主的场景
```

### 推荐配置

```yaml
# 开发环境
python: "3.10+"
llm_api: "claude-3-5-sonnet-20241022"  # 或 gpt-4-turbo
agent_framework: "langchain"  # 或自研
vector_db: "chromadb"
embedding: "text-embedding-3-small"  # OpenAI embedding

# 依赖包
dependencies:
  - langchain>=0.1.0
  - openai>=1.0.0
  - anthropic>=0.8.0
  - chromadb>=0.4.0
  - pandas>=2.0.0
  - python-dotenv>=1.0.0
```

---

## 数据资源

### 现有数据清单

```
项目目录/
├── 《汉语大词典》结构化/
│   ├── dyhdc.parsed.fixed.v2.jsonl  # 1.9GB，核心字典数据
│   ├── dyhdc_jsonl_schema_zh.md      # 数据结构说明
│   ├── dyhdc.sample100.v3.txt        # 100条样例
│   └── jsonl_to_text.py              # 转换脚本
│
├── 王力古漢語字典 (2000)/
│   ├── 王力古漢語字典 (2000).mdx     # 5.5MB，古汉语释义
│   └── 王力字典 上古擬音 (Baxter-Sagart).mdx  # 上古音数据
│
├── 音韵数据/
│   ├── 上古音/
│   │   ├── 潘悟云《汉语古音手册》/   # 上古音数据
│   │   ├── 斯塔罗斯金汉语拟音/       # 多时期拟音
│   │   └── 白一平-沙加尔的汉语拟音体系/  # BaxterSagart
│   ├── 中古音/
│   │   └── 廣韻 (2008)/              # 中古音数据
│   └── 近代音/
│       └── 中原音韵/                  # 近代音数据
│
└── 参考资料/
    ├── 参考资料2.txt                  # 冯浩菲《中国训诂学》
    ├── 参考资料3.txt                  # 训诂学方法论
    ├── 参考资料4.txt                  # 齐佩瑢《训诂学概论》
    └── 实践项目.txt                   # 项目需求文档
```

### 数据用途映射

| 数据源 | 用于步骤 | 主要用途 |
|--------|----------|----------|
| 《汉语大词典》JSONL | 第一步、第三步 | 查字义、查例句、查假借标注 |
| 《王力古汉语字典》 | 第一步 | 查古汉语本义 |
| 上古音数据 | 第二步 | 判断声母韵部是否音近 |
| 训式规则表 | 第四步 | 正则匹配训诂格式 |
| 参考资料 | 测试集构建 | 提取已标注的训诂句 |

### 数据预处理需求

1. **《汉语大词典》**
   - [x] 已有JSONL格式，可直接使用
   - [ ] 需建立字→条目的快速索引
   - [ ] 可选：向量化存入ChromaDB

2. **上古音数据**
   - [x] 潘悟云数据已有TXT格式
   - [ ] 需解析为字→音韵的字典
   - [ ] 统一多来源数据格式

3. **MDX字典**
   - [ ] 需开发MDX解析器（或使用现有库）
   - [ ] 提取为可查询的JSON格式

---

## 五步推理流程

### 流程图

```
输入训诂句
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│ 第一步：语义关联性分析                                   │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 调用工具：query_word_meaning(被释字)                 │ │
│ │ 调用工具：query_word_meaning(释字)                   │ │
│ │ LLM判断：两字本义是否有语义关联？                    │ │
│ └─────────────────────────────────────────────────────┘ │
│ 输出：义近 / 义远                                        │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│ 第二步：语音对应分析                                     │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 调用工具：query_phonology(被释字)                    │ │
│ │ 调用工具：query_phonology(释字)                      │ │
│ │ 规则判断：声母/韵部是否同部或相近？                  │ │
│ └─────────────────────────────────────────────────────┘ │
│ 输出：音近 / 音远                                        │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│ 第三步：异文与文例佐证                                   │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 调用工具：search_textual_evidence(被释字, 释字)      │ │
│ │ 检索：是否有平行文献使用不同字形？                   │ │
│ │ 检索：词典中是否有假借标注？                         │ │
│ └─────────────────────────────────────────────────────┘ │
│ 输出：有异文佐证 / 无异文佐证                            │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│ 第四步：训诂术语与训式识别                               │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 调用工具：identify_xunshi_pattern(训诂句)            │ │
│ │ 正则匹配：使用了什么训释格式？                       │ │
│ │ 规则判断：该格式暗示什么类型？                       │ │
│ └─────────────────────────────────────────────────────┘ │
│ 输出：直接判假借 / 直接判语义 / 需综合判断               │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│ 第五步：语境适配度分析                                   │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 获取原始句子上下文                                   │ │
│ │ LLM分析：被释字本义代入是否通顺？                    │ │
│ │ LLM分析：释字本义代入是否通顺？                      │ │
│ └─────────────────────────────────────────────────────┘ │
│ 输出：A通B不通 / A不通B通 / 都通 / 都不通                │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────┐
│ 综合判定                                                 │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 如果：义远 + 音近 + 有异文 + 语境支持                │ │
│ │ 则：假借说明（高置信度）                             │ │
│ │                                                       │ │
│ │ 如果：义近 + 音近 + 无异文 + 语境都通                │ │
│ │ 则：语义解释/以声通义（高置信度）                    │ │
│ │                                                       │ │
│ │ 其他情况：综合权衡，给出置信度                       │ │
│ └─────────────────────────────────────────────────────┘ │
│ 输出：最终分类 + 置信度 + 完整推理链                     │
└─────────────────────────────────────────────────────────┘
```

### 判定逻辑表

| 义 | 音 | 异文 | 训式 | 语境 | 判定 | 置信度 |
|----|----|----|------|------|------|--------|
| 远 | 近 | 有 | 假借 | A不通B通 | **假借** | 极高 |
| 远 | 近 | 有 | 不定 | A不通B通 | **假借** | 高 |
| 远 | 近 | 无 | 假借 | A不通B通 | **假借** | 高 |
| 远 | 近 | 无 | 不定 | A不通B通 | **假借** | 中 |
| 近 | 近 | 无 | 语义 | 都通 | **语义解释** | 高 |
| 近 | 近 | 无 | 不定 | 都通 | **语义解释** | 中 |
| 近 | 近 | 有 | 不定 | - | **需人工判断** | 低 |

---

## 实现计划

### 模块分解

```
src/
├── agent/                    # Agent核心
│   ├── __init__.py
│   ├── xungu_agent.py       # 主Agent类
│   ├── prompts.py           # Prompt模板
│   └── chains.py            # 推理链定义
│
├── tools/                    # 工具函数
│   ├── __init__.py
│   ├── semantic_tool.py     # 字义查询工具
│   ├── phonology_tool.py    # 音韵查询工具
│   ├── textual_tool.py      # 文献检索工具
│   ├── pattern_tool.py      # 训式识别工具
│   └── context_tool.py      # 语境分析工具
│
├── knowledge/                # 知识库管理
│   ├── __init__.py
│   ├── dictionary_loader.py # 字典加载器
│   ├── phonology_loader.py  # 音韵数据加载器
│   ├── pattern_rules.py     # 训式规则定义
│   └── vector_store.py      # 向量存储管理
│
├── data/                     # 数据处理
│   ├── __init__.py
│   ├── preprocess.py        # 数据预处理
│   ├── mdx_parser.py        # MDX解析器
│   └── index_builder.py     # 索引构建
│
├── evaluation/               # 评估模块
│   ├── __init__.py
│   ├── test_dataset.py      # 测试数据集
│   ├── metrics.py           # 评估指标
│   └── error_analysis.py    # 错误分析
│
├── config/                   # 配置
│   ├── __init__.py
│   ├── settings.py          # 全局设置
│   └── prompts_config.yaml  # Prompt配置
│
└── main.py                   # 入口文件
```

### 开发优先级

```
P0 - 核心功能（必须完成）
├── 基础Agent框架搭建
├── 字义查询工具（汉语大词典）
├── 音韵查询工具（上古音数据）
├── 训式识别工具（正则匹配）
└── 五步推理流程实现

P1 - 重要功能（应该完成）
├── 文献检索工具
├── 语境分析工具
├── 测试数据集构建
└── 基础评估指标

P2 - 增强功能（可选完成）
├── 向量检索优化
├── MDX字典解析
├── 细粒度分类
└── 可视化界面
```

---

## 团队分工

### 角色建议（5人团队）

| 角色 | 人数 | 主要职责 |
|------|------|----------|
| **架构师/PM** | 1人 | 整体设计、进度管理、代码审查 |
| **Agent开发** | 1人 | Agent框架、Prompt工程、推理链 |
| **工具开发** | 2人 | 五个工具函数的实现 |
| **数据工程** | 1人 | 数据预处理、知识库构建、测试集 |

### 具体任务分配

```
成员A（架构师/PM）
├── 系统架构设计
├── 接口定义
├── 代码审查
├── 文档编写
└── 最终整合与答辩

成员B（Agent开发）
├── Agent框架搭建
├── Prompt设计与优化
├── 五步推理链实现
└── 综合判定逻辑

成员C（工具开发-语义）
├── 字义查询工具（第一步）
├── 语境分析工具（第五步）
└── 《汉语大词典》接口

成员D（工具开发-音韵）
├── 音韵查询工具（第二步）
├── 训式识别工具（第四步）
└── 上古音数据处理

成员E（数据工程）
├── 数据预处理脚本
├── 知识库索引构建
├── 测试数据集构建
└── 评估与错误分析
```

---

## 项目结构

```
训诂分类项目/
├── README.md                 # 本文件
├── requirements.txt          # Python依赖
├── .env.example             # 环境变量模板
├── .gitignore
│
├── src/                      # 源代码
│   ├── agent/
│   ├── tools/
│   ├── knowledge/
│   ├── data/
│   ├── evaluation/
│   ├── config/
│   └── main.py
│
├── data/                     # 数据文件
│   ├── raw/                  # 原始数据
│   │   ├── 《汉语大词典》结构化/
│   │   ├── 王力古漢語字典/
│   │   └── 音韵数据/
│   ├── processed/            # 处理后数据
│   └── test/                 # 测试数据集
│
│
├── docs/                     # 文档
│   ├── architecture.md       # 架构设计
│   ├── api.md               # API文档
│   └── evaluation.md        # 评估报告
│
├── tests/                    # 测试代码
│   ├── test_tools.py
│   ├── test_agent.py
│   └── test_integration.py
│
└── 参考资料/                  # 参考资料
    ├── 参考资料2.txt
    ├── 参考资料3.txt
    ├── 参考资料4.txt
    └── 实践项目.txt
```

---

## 使用说明

### 环境配置

```bash
# 1. 克隆项目
git clone <repository_url>
cd 训诂分类项目

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填入 API Key
```

### 数据预处理

```bash
# 预处理汉语大词典
python src/data/preprocess.py --source dyhdc

# 预处理音韵数据
python src/data/preprocess.py --source phonology

# 构建索引
python src/data/index_builder.py
```

### 运行系统

```bash
# 命令行模式
python src/main.py --input "崇，终也" --context "崇朝其雨"

# 交互模式
python src/main.py --interactive

# 批量处理
python src/main.py --batch data/test/test_dataset.json --output results.json
```

### API调用

```python
from src.agent import XunguAgent

# 初始化Agent
agent = XunguAgent()

# 单条分析
result = agent.analyze(
    xungu_sentence="崇，终也",
    context="崇朝其雨",
    source="《毛传》"
)

print(result.classification)  # "假借说明"
print(result.reasoning)       # 五步推理详情
print(result.confidence)      # 0.95
```

---

## 评估与测试

### 测试数据集来源

测试数据从参考资料中提取，包含明确标注类型的训诂句：

| 来源 | 数量 | 类型分布 |
|------|------|----------|
| 参考资料2（冯浩菲） | ~30条 | 假借/语义混合 |
| 参考资料3 | ~20条 | 假借/语义混合 |
| 参考资料4（齐佩瑢） | ~20条 | 假借/语义混合 |

### 评估指标

```python
# 主要指标
accuracy = 正确分类数 / 总数
precision_假借 = 真假借 / 预测为假借
recall_假借 = 真假借 / 实际假借
f1_假借 = 2 * precision * recall / (precision + recall)

# 同理计算语义解释的指标
precision_语义, recall_语义, f1_语义

# 宏平均
macro_f1 = (f1_假借 + f1_语义) / 2
```

### 错误分析

对于分类错误的case，分析：
1. 哪一步推理出错？
2. 是工具返回错误还是LLM推理错误？
3. 是否需要补充知识库数据？

---

## 参考文献

### 训诂学参考

1. 冯浩菲.《中国训诂学》（参考资料2）
2. 齐佩瑢.《训诂学概论》（参考资料4）
3. 郭在贻.《训诂学》
4. 陆宗达、王宁.《训诂方法论》

### 技术参考

1. LangChain Documentation: https://python.langchain.com/
2. OpenAI Function Calling: https://platform.openai.com/docs/guides/function-calling
3. Anthropic Claude: https://docs.anthropic.com/

### 语音学参考

1. 王力.《汉语音韵学》
2. Baxter, William H., and Laurent Sagart. "Old Chinese: A New Reconstruction." (2014)
3. 潘悟云.《汉语古音手册》

---

## 许可证

本项目仅供学术研究和课程学习使用。

---


*本README将随项目进展持续更新。*
