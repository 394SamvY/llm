# 训诂句类型智能判断系统

> 大语言模型课程实践项目 - 数字人文方向
> 
> 基于LLM Agent的古汉语训诂分类系统

## 🎯 项目状态：已完成

| 指标 | 结果 |
|------|------|
| **准确率** | **86.67%** (52/60) |
| **宏平均F1** | **84.60%** |
| 假借说明 F1 | 78.95% |
| 语义解释 F1 | 90.24% |
| 测试数据集 | 60条（假借17/语义43） |
| 评估时间 | 2026-01-19 |

详细评估报告：[docs/EVALUATION_REPORT.md](docs/EVALUATION_REPORT.md)

---

## 🧪 教师测试入口

### 方式一：使用测试脚本（推荐）

1. 编辑 `test_for_teacher.py`，在 `TEST_CASES` 列表中添加测试用例：

```python
TEST_CASES = [
    {
        "训诂句": "崇，终也",
        "上下文": "崇朝其雨",  # 可选
        "出处": "《毛传》",     # 可选
    },
    # 添加更多...
]
```

2. 运行测试：

```bash
python test_for_teacher.py
```

3. 查看结果：终端输出 + JSON文件

### 方式二：命令行单条测试

```bash
python -m src.main --input "训诂句内容" --context "上下文" --verbose
```

---

## 📋 目录

- [项目概述](#项目概述)
- [快速开始](#快速开始)
- [系统架构](#系统架构)
- [五步推理流程](#五步推理流程)
- [项目结构](#项目结构)
- [使用说明](#使用说明)
- [数据资源](#数据资源)
- [评估结果](#评估结果)
- [团队分工](#团队分工)

---

## 项目概述

### 背景

训诂学是中国传统语言学的核心组成部分。在古代训诂实践中，存在两种重要的训释类型：

1. **以声通义法**（语义解释）：利用声音相近的词来解释词义，揭示词的语源
2. **揭明正借字法**（假借说明）：指出文献中某字是另一字的假借

这两种类型在形式上常常相似（都涉及音近字），但本质不同：
- 语义解释：**音近义近**，A与B有语义关联
- 假借说明：**音近义远**，A只是借用了B的音，本身无义

### 项目目标

构建一个基于大语言模型的智能Agent系统，能够：

1. **自动分类**：判断输入的训诂句属于"语义解释"还是"假借说明"
2. **提供推理链**：输出完整的五步推理过程和证据
3. **工具调用**：自主调用字典查询、音韵查询等外部工具获取信息

---

## 快速开始

### 1. 环境配置

```bash
# 克隆项目
git clone <repository_url>
cd llm

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate  # Linux/Mac

# 安装依赖
pip install -r requirements.txt

# 配置环境变量（.env 文件已包含，如需修改请直接编辑）
# 编辑 .env 文件，填入你的 API Key
```

### 2. 配置 `.env` 文件

```bash
# .env 文件内容
OPENAI_API_KEY=your-api-key-here
OPENAI_BASE_URL=https://api.openai.com/v1
LLM_MODEL=gpt-4o
```

### 3. 运行系统

```bash
# 单条分析
python -m src.main --input "崇，终也" --context "崇朝其雨" --verbose

# 运行评估（60条测试集）
python -m src.main --evaluate
```

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户输入层                               │
│                  (训诂句 + 上下文信息)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Agent 核心层                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              XunguAgent (LangChain)                      │   │
│  │                                                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ 任务规划 │  │ 工具调用 │  │ 结果整合 │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                │                                 │
│                         工具调用接口                             │
│                                │                                 │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐      │
│  │ 语义查询 │ 音韵查询 │ 文献检索 │ 训式识别 │ 语境分析 │      │
│  │ Step 1  │ Step 2  │ Step 3  │ Step 4  │ Step 5  │      │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        知识库层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │《汉语大词典》 │  │  上古音数据  │  │  训式规则库  │          │
│  │  40.8万条目  │  │  1.37万字   │  │   正则匹配   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 核心组件

| 组件 | 功能 | 实现 |
|------|------|------|
| **XunguAgent** | 五步推理、工具调用 | `src/agent/xungu_agent.py` |
| **语义查询工具** | 查询字义 | `src/tools/semantic_tool.py` |
| **音韵查询工具** | 查询上古音 | `src/tools/phonology_tool.py` |
| **文献检索工具** | 查询异文佐证 | `src/tools/textual_tool.py` |
| **训式识别工具** | 识别训诂格式 | `src/tools/pattern_tool.py` |
| **语境分析工具** | 分析语义通顺度 | `src/tools/context_tool.py` |

---

## 五步推理流程

```
输入：训诂句 + 上下文
         │
         ▼
┌────────────────────────────────────┐
│ 第一步：语义关联性分析              │
│ 工具：query_word_meaning            │
│ 输出：义近 / 义远                   │
└────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ 第二步：语音对应分析                │
│ 工具：query_phonology               │
│ 输出：音近 / 音远                   │
└────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ 第三步：异文与文例佐证              │
│ 工具：search_textual_evidence       │
│ 输出：有佐证 / 无佐证               │
└────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ 第四步：训诂术语与训式识别          │
│ 工具：identify_pattern              │
│ 输出：假借格式 / 语义格式 / 不确定   │
└────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ 第五步：语境适配度分析              │
│ 工具：analyze_context               │
│ 输出：支持假借 / 支持语义 / 不确定   │
└────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ 综合判定                            │
│ 输出：假借说明 / 语义解释 + 置信度   │
└────────────────────────────────────┘
```

### 判定逻辑

| 义 | 音 | 异文 | 训式 | 语境 | 判定 |
|----|----|----|------|------|------|
| 远 | 近 | 有 | 假借 | 支持假借 | **假借说明** |
| 远 | 近 | 无 | 不定 | 支持假借 | **假借说明** |
| 近 | 近 | 无 | 语义 | 都通 | **语义解释** |
| 近 | 近 | 无 | 不定 | 都通 | **语义解释** |

---

## 项目结构

```
llm/
├── README.md                    # 本文件
├── requirements.txt             # Python依赖
├── .env                         # 环境变量配置
├── .gitignore
│
├── src/                         # 源代码
│   ├── main.py                  # 主入口
│   ├── agent/                   # Agent核心
│   │   ├── xungu_agent.py       # 主Agent类
│   │   ├── llm_client.py        # LLM客户端
│   │   ├── prompts.py           # Prompt模板
│   │   └── tool_wrappers.py     # 工具封装
│   ├── tools/                   # 五个工具函数
│   │   ├── semantic_tool.py     # 语义查询
│   │   ├── phonology_tool.py    # 音韵查询
│   │   ├── textual_tool.py      # 文献检索
│   │   ├── pattern_tool.py      # 训式识别
│   │   └── context_tool.py      # 语境分析
│   ├── knowledge/               # 知识库加载
│   │   ├── dictionary_loader.py # 词典加载
│   │   └── phonology_loader.py  # 音韵加载
│   ├── data/                    # 数据处理
│   │   ├── dyhdc_index_builder.py
│   │   └── phonology_parser.py
│   ├── evaluation/              # 评估模块
│   │   ├── metrics.py           # 评估指标
│   │   ├── test_dataset.py      # 测试数据集
│   │   └── error_analysis.py    # 错误分析
│   └── config/                  # 配置
│       └── settings.py          # 全局设置
│
├── data/                        # 数据文件
│   ├── processed/               # 处理后数据
│   │   ├── dyhdc_index.json     # 词典索引
│   │   ├── phonology_unified.json
│   │   └── evaluation_results.json
│   └── test/
│       └── test_dataset.json    # 60条测试集
│
├── docs/                        # 文档
│   ├── ARCHITECTURE.md          # 架构设计
│   ├── EVALUATION_REPORT.md     # 评估报告
│   ├── PRESENTATION.md          # 演示文稿
│   └── API.md                   # API文档
│
├── 《汉语大词典》结构化/          # 词典数据（1.9GB）
├── 音韵数据/                     # 上古音数据
├── 王力古漢語字典 (2000)/        # 古汉语字典
└── 参考资料/                     # 参考文献
```

---

## 使用说明

### API 调用

```python
from src.agent import XunguAgent

# 初始化Agent
agent = XunguAgent(verbose=True)

# 单条分析
result = agent.analyze(
    xungu_sentence="崇，终也",
    context="崇朝其雨",
    source="《毛传》"
)

print(result.classification)  # "假借说明"
print(result.confidence)      # 0.95
print(result.to_json())       # 完整JSON输出
```


### 输出示例

```json
{
  "input": {
    "训诂句": "崇，终也",
    "被释字": "崇",
    "释字": "终",
    "上下文": "崇朝其雨",
    "出处": "《毛传》"
  },
  "classification": "假借说明",
  "confidence": 0.95,
  "reasoning": {
    "step1_semantic": "义远 - 崇(高大)与终(终结)无语义关联",
    "step2_phonetic": "音近 - 同属东部韵",
    "step3_textual": "有异文 - 《小雅·采绿》作'终朝'",
    "step4_pattern": "基本格式 - 不确定类型",
    "step5_context": "支持假借 - '终朝'语义通顺"
  },
  "final_judgment": "义远、音近、有异文佐证，判定为假借说明"
}
```

---

## 数据资源

### 知识库统计

| 数据源 | 规模 | 用途 |
|--------|------|------|
| 《汉语大词典》 | 40.8万条目 | 字义查询、假借标注 |
| 上古音数据 | 1.37万字 | 音韵查询 |
| 测试数据集 | 60条 | 评估验证 |

### 数据来源

- **《汉语大词典》**：JSONL格式，包含字义、例句、假借标注
- **上古音数据**：潘悟云《汉语古音手册》+ 白一平-沙加尔拟音
- **测试数据集**：人工标注的60条训诂句

---

## 评估结果

### 总体指标

| 指标 | 值 |
|------|------|
| 准确率 (Accuracy) | **86.67%** |
| 宏平均F1 (Macro-F1) | **84.60%** |
| 正确数/总数 | 52/60 |

### 分类指标

| 类别 | 精确率 | 召回率 | F1 |
|------|--------|--------|------|
| 假借说明 | 71.43% | 88.24% | 78.95% |
| 语义解释 | 94.87% | 86.05% | 90.24% |

### 混淆矩阵

```
              预测假借  预测语义
实际假借        15        2
实际语义         6       37
```

---

## 团队分工

| 角色 | 职责 |
|------|------|
| **成员A（架构师/PM）** | 系统架构、接口定义、代码审查、最终整合 |
| **成员B（Agent开发）** | Agent框架、Prompt设计、五步推理链 |
| **成员C（工具开发-语义）** | 字义查询、语境分析、词典接口 |
| **成员D（工具开发-音韵）** | 音韵查询、训式识别、上古音处理 |
| **成员E（数据工程）** | 数据预处理、索引构建、测试评估 |

---

## 参考文献

### 训诂学
- 冯浩菲.《中国训诂学》
- 齐佩瑢.《训诂学概论》
- 陆宗达、王宁.《训诂方法论》

### 语音学
- 王力.《汉语音韵学》
- Baxter & Sagart. "Old Chinese: A New Reconstruction" (2014)
- 潘悟云.《汉语古音手册》

### 技术
- LangChain Documentation
- OpenAI API Documentation

---

